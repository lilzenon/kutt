{{> header}}

<link rel="stylesheet" href="/css/drop-edit.css">

<div class="drop-edit-container">
    <div class="drop-edit-header">
        <div class="header-content">
            <button type="button" class="back-button" onclick="window.history.back()">
                {{> icons/arrow_left}}
                <span>Back</span>
            </button>
            <h1>Edit Drop</h1>
        </div>
    </div>

    <div class="drop-edit-content">
        <div class="drop-edit-form-container">
            <form id="drop-edit-form" class="drop-form">
                <!-- Basic Information -->
                <div class="form-section">
                    <h2>Basic Information</h2>

                    <div class="form-group">
                        <label for="edit-title">Title *</label>
                        <input type="text" id="edit-title" name="title" required maxlength="255"
                               value="{{drop.title}}" placeholder="Enter drop title">
                    </div>

                    <div class="form-group">
                        <label for="edit-description">Description</label>
                        <textarea id="edit-description" name="description" rows="4"
                                  placeholder="Describe what this drop is about">{{drop.description}}</textarea>
                    </div>

                    <div class="form-group">
                        <label for="edit-slug">URL Slug</label>
                        <div class="slug-input-wrapper">
                            <span class="slug-prefix">{{domain}}/drop/</span>
                            <input type="text" id="edit-slug" name="slug" maxlength="100"
                                   value="{{drop.slug}}" placeholder="my-drop">
                        </div>
                        <small class="form-help">This will be your drop's public URL</small>
                    </div>
                </div>

                <!-- Appearance -->
                <div class="form-section">
                    <h2>Appearance</h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-background-color">Background Color</label>
                            <input type="color" id="edit-background-color" name="background_color"
                                   value="{{drop.background_color}}">
                        </div>

                        <div class="form-group">
                            <label for="edit-card-color">Card Color</label>
                            <input type="color" id="edit-card-color" name="card_color"
                                   value="{{drop.card_color}}">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-title-color">Title Text Color</label>
                            <input type="color" id="edit-title-color" name="title_color"
                                   value="{{drop.title_color}}">
                        </div>

                        <div class="form-group">
                            <label for="edit-description-color">Description Text Color</label>
                            <input type="color" id="edit-description-color" name="description_color"
                                   value="{{drop.description_color}}">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-button-color">Button Color</label>
                            <input type="color" id="edit-button-color" name="button_color"
                                   value="{{drop.button_color}}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="edit-button-text">Button Text</label>
                        <input type="text" id="edit-button-text" name="button_text" maxlength="50"
                               value="{{drop.button_text}}" placeholder="Get Notified">
                    </div>

                    <div class="form-group">
                        <label for="edit-cover-image">Cover Image URL</label>
                        <input type="url" id="edit-cover-image" name="cover_image"
                               value="{{drop.cover_image}}" placeholder="https://example.com/image.jpg">
                        <small class="form-help">Optional: Add a cover image for your drop</small>
                    </div>
                </div>

                <!-- Visibility & Access Control -->
                <div class="form-section">
                    <h2>Visibility & Access Control</h2>

                    <div class="form-group">
                        <div class="setting-group">
                            <div class="setting-header">
                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="is_active" {{#if drop.is_active}}checked{{/if}}>
                                        <span class="checkbox-custom"></span>
                                        <span class="checkbox-text">Active Drop</span>
                                    </label>
                                </div>
                                <div class="setting-status">
                                    <span class="status-indicator {{#if drop.is_active}}active{{else}}inactive{{/if}}">
                                        {{#if drop.is_active}}Live{{else}}Draft{{/if}}
                                    </span>
                                </div>
                            </div>
                            <div class="setting-description">
                                <p>When active, your drop is publicly accessible and accepts signups. When inactive, the drop URL will show a "Drop Inactive" page and block all signups.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Collection -->
                <div class="form-section">
                    <h2>Data Collection</h2>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="collect_email" {{#if drop.collect_email}}checked{{/if}}>
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-text">Collect email addresses</span>
                            </label>
                        </div>
                        <small class="form-help">Required for sending notifications when the drop goes live</small>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="collect_phone" {{#if drop.collect_phone}}checked{{/if}}>
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-text">Collect phone numbers</span>
                            </label>
                        </div>
                        <small class="form-help">Optional: Collect phone numbers for SMS notifications</small>
                    </div>
                </div>

                <!-- Messages -->
                <div class="form-section">
                    <h2>Messages</h2>

                    <div class="form-group">
                        <label for="edit-thank-you-message">Thank You Message</label>
                        <textarea id="edit-thank-you-message" name="thank_you_message" rows="3"
                                  placeholder="Thank you for signing up! You'll be notified when this drop goes live.">{{drop.thank_you_message}}</textarea>
                        <small class="form-help">Message shown after successful signup</small>
                    </div>
                </div>

                <!-- Actions -->
                <div class="form-actions">
                    <button type="button" class="button secondary" onclick="window.history.back()">
                        Cancel
                    </button>
                    <button type="submit" class="button primary">
                        <span class="button-text">Save Changes</span>
                        <span class="button-spinner" style="display: none;">
                            {{> icons/spinner}}
                        </span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Enhanced Preview Panel -->
        <div class="drop-preview-panel">
            <!-- Mobile Toggle Button (hidden on desktop) -->
            <button type="button" class="preview-toggle" onclick="togglePreview()">
                <span>Live Preview</span>
                <div class="preview-toggle-actions">
                    <a href="/drop/{{drop.slug}}" target="_blank" class="preview-quick-link" title="Open in new tab">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z"/>
                        </svg>
                    </a>
                    <svg class="preview-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7 10l5 5 5-5z"/>
                    </svg>
                </div>
            </button>

            <div class="preview-collapsible">
                <div class="preview-header">
                    <div class="preview-title-section">
                        <h3>Live Preview</h3>
                        <span class="preview-device-indicator" id="device-indicator">Desktop View</span>
                    </div>
                    <div class="preview-controls">
                        <button type="button" class="preview-device-btn active" data-device="desktop" title="Desktop View">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21 2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h7l-2 3v1h8v-1l-2-3h7c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 12H3V4h18v10z"/>
                            </svg>
                        </button>
                        <button type="button" class="preview-device-btn" data-device="mobile" title="Mobile View">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M17 2H7c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM7 4h10v14H7V4z"/>
                            </svg>
                        </button>
                    </div>
                </div>

            <div class="preview-container">
                <div class="preview-viewport" id="preview-viewport">
                    <div class="drop-page-wrapper">
                        <div class="drop-container" id="drop-preview">
                        <!-- Header -->
                        <header class="drop-header">
                            <div class="drop-brand">
                                <a href="/" class="brand-link">
                                    <img src="/images/logo.png" alt="BOUNCE2BOUNCE" class="brand-logo">
                                    <span class="brand-text" id="preview-brand-text">BOUNCE2BOUNCE</span>
                                </a>
                            </div>
                        </header>

                        <!-- Main Content -->
                        <main class="drop-main">
                            <div class="drop-content">
                                <div class="drop-cover-image" id="preview-cover" style="display: none;">
                                    <img id="preview-cover-image" src="" alt="Cover" loading="lazy">
                                </div>

                                <div class="drop-info">
                                    <h1 class="drop-title" id="preview-title">{{drop.title}}</h1>

                                    <div class="drop-description">
                                        <p id="preview-description">{{drop.description}}</p>
                                    </div>

                                    <div class="drop-stats">
                                        <span class="signup-count" id="preview-signup-count">42 people signed up</span>
                                    </div>
                                </div>

                                <!-- Signup Form -->
                                <div class="drop-signup-section">
                                    <form class="signup-form">
                                        <div class="form-group">
                                            <input type="email" placeholder="Enter your email" readonly class="form-input preview-input">
                                        </div>
                                        <div class="form-group">
                                            <input type="text" placeholder="Your name (optional)" readonly class="form-input preview-input">
                                        </div>
                                        <button type="button" class="signup-button" id="preview-button">
                                            <span class="button-text" id="preview-button-text">{{drop.button_text}}</span>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </main>

                        <!-- Footer -->
                        <footer class="drop-footer">
                            <p>Powered by <a href="/" class="footer-link">BOUNCE2BOUNCE</a></p>
                        </footer>
                        </div>
                    </div>
                </div>
            </div>

                <div class="preview-info-panel">
                    <div class="preview-url">
                        <label>Preview URL:</label>
                        <div class="url-display">
                            <span class="url-prefix">{{domain}}/drop/</span>
                            <span class="url-slug" id="preview-url-slug">{{drop.slug}}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>

<div id="edit-error" class="error-message" style="display: none;"></div>
<div id="edit-success" class="success-message" style="display: none;"></div>

{{> footer}}

<!-- Modular Systems -->
<link rel="stylesheet" href="/css/drop-shared.css">
<script src="/js/drop-color-system.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('drop-edit-form');
    const dropId = '{{drop.id}}';

    // Enhanced real-time preview updates
    const titleInput = document.getElementById('edit-title');
    const descriptionInput = document.getElementById('edit-description');
    const slugInput = document.getElementById('edit-slug');
    const buttonTextInput = document.getElementById('edit-button-text');
    const buttonColorInput = document.getElementById('edit-button-color');
    const backgroundColorInput = document.getElementById('edit-background-color');
    const cardColorInput = document.getElementById('edit-card-color');
    const titleColorInput = document.getElementById('edit-title-color');
    const descriptionColorInput = document.getElementById('edit-description-color');
    const coverImageInput = document.getElementById('edit-cover-image');

    const previewDrop = document.getElementById('drop-preview');
    const previewTitle = document.getElementById('preview-title');
    const previewDescription = document.getElementById('preview-description');
    const previewButton = document.getElementById('preview-button');
    const previewButtonText = document.getElementById('preview-button-text');
    const previewUrlSlug = document.getElementById('preview-url-slug');
    const previewCover = document.getElementById('preview-cover');
    const previewCoverImage = document.getElementById('preview-cover-image');
    const previewViewport = document.getElementById('preview-viewport');

    // Initialize preview with current values
    function initializePreview() {
        updatePreviewColors();
        updatePreviewContent();
    }

    // Simple, working color system
    function updatePreviewColors() {
        const backgroundColor = backgroundColorInput.value || '#ffffff';
        const cardColor = cardColorInput.value || '#ffffff';
        const titleColor = titleColorInput.value || '#000000';
        const descriptionColor = descriptionColorInput.value || '#666666';
        const buttonColor = buttonColorInput.value || '#007bff';

        console.log('Updating preview colors:', { backgroundColor, cardColor, titleColor, descriptionColor, buttonColor });

        // Apply CSS custom properties directly to the preview container
        const previewContainer = previewDrop.closest('.preview-viewport') || previewDrop;

        // Set CSS variables
        previewContainer.style.setProperty('--drop-background-color', backgroundColor);
        previewContainer.style.setProperty('--drop-card-color', cardColor);
        previewContainer.style.setProperty('--drop-title-color', titleColor);
        previewContainer.style.setProperty('--drop-description-color', descriptionColor);
        previewContainer.style.setProperty('--drop-button-color', buttonColor);

        // Calculate and set button text color
        const buttonTextColor = getContrastColor(buttonColor);
        previewContainer.style.setProperty('--drop-button-text-color', buttonTextColor);

        console.log('Applied CSS variables to preview container');
    }

    // Update preview content
    function updatePreviewContent() {
        previewTitle.textContent = titleInput.value || 'Drop Title';
        previewDescription.textContent = descriptionInput.value || 'Drop description';
        previewButtonText.textContent = buttonTextInput.value || 'Get Notified';
        previewUrlSlug.textContent = slugInput.value || 'drop-slug';

        // Handle cover image
        const coverImageUrl = coverImageInput.value;
        if (coverImageUrl && isValidUrl(coverImageUrl)) {
            previewCoverImage.src = coverImageUrl;
            previewCover.style.display = 'block';
        } else {
            previewCover.style.display = 'none';
        }
    }

    // Calculate contrast color for text on colored backgrounds
    function getContrastColor(hexColor) {
        // Remove # if present
        const color = hexColor.replace('#', '');

        // Convert to RGB
        const r = parseInt(color.substr(0, 2), 16);
        const g = parseInt(color.substr(2, 2), 16);
        const b = parseInt(color.substr(4, 2), 16);

        // Calculate luminance
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;

        // Return white for dark colors, black for light colors
        return luminance > 0.5 ? '#000000' : '#ffffff';
    }

    // Validate URL
    function isValidUrl(string) {
        try {
            new URL(string);
            return true;
        } catch (_) {
            return false;
        }
    }

    // Event listeners for real-time updates
    titleInput.addEventListener('input', updatePreviewContent);
    descriptionInput.addEventListener('input', updatePreviewContent);
    slugInput.addEventListener('input', updatePreviewContent);
    buttonTextInput.addEventListener('input', updatePreviewContent);
    coverImageInput.addEventListener('input', updatePreviewContent);

    buttonColorInput.addEventListener('input', updatePreviewColors);
    backgroundColorInput.addEventListener('input', updatePreviewColors);
    cardColorInput.addEventListener('input', updatePreviewColors);
    titleColorInput.addEventListener('input', updatePreviewColors);
    descriptionColorInput.addEventListener('input', updatePreviewColors);

    // Device preview toggle with real device simulation
    const deviceButtons = document.querySelectorAll('.preview-device-btn');
    deviceButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            deviceButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const device = btn.dataset.device;
            updateDevicePreview(device);
        });
    });

    // Function to update device preview to match real experience
    function updateDevicePreview(device) {
        // Simply update the viewport class - let CSS handle everything else
        previewViewport.className = `preview-viewport ${device}`;

        // Update device indicator
        const deviceIndicator = document.getElementById('device-indicator');
        if (deviceIndicator) {
            deviceIndicator.textContent = device === 'mobile' ? 'Mobile View' : 'Desktop View';
        }

        // Let the shared CSS system handle all styling automatically
        // No manual JavaScript overrides - CSS variables and media queries handle everything
        console.log(`Updated device preview to: ${device}`);
    }

    // Auto-detect user's current device and set appropriate preview
    function detectAndSetDevicePreview() {
        const isMobile = window.innerWidth <= 768;
        const defaultDevice = isMobile ? 'mobile' : 'desktop';

        // Set the appropriate device button as active
        deviceButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.device === defaultDevice) {
                btn.classList.add('active');
            }
        });

        // Update preview to match user's actual device
        updateDevicePreview(defaultDevice);
    }

    // Initialize preview
    initializePreview();

    // Set device preview based on user's actual device
    detectAndSetDevicePreview();

    // Update device preview when window is resized
    window.addEventListener('resize', () => {
        detectAndSetDevicePreview();
    });

    // Mobile preview toggle functionality
    window.togglePreview = function() {
        const toggle = document.querySelector('.preview-toggle');
        const collapsible = document.querySelector('.preview-collapsible');
        const icon = document.querySelector('.preview-toggle-icon');

        if (collapsible.classList.contains('collapsed')) {
            collapsible.classList.remove('collapsed');
            toggle.classList.remove('collapsed');
        } else {
            collapsible.classList.add('collapsed');
            toggle.classList.add('collapsed');
        }
    };

    // Auto-collapse preview on mobile by default
    if (window.innerWidth <= 768) {
        const toggle = document.querySelector('.preview-toggle');
        const collapsible = document.querySelector('.preview-collapsible');

        if (toggle && collapsible) {
            collapsible.classList.add('collapsed');
            toggle.classList.add('collapsed');
        }
    }

    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        // Convert checkboxes to booleans
        data.is_active = formData.has('is_active');
        data.collect_email = formData.has('collect_email');
        data.collect_phone = formData.has('collect_phone');

        const submitBtn = this.querySelector('button[type="submit"]');
        const buttonText = submitBtn.querySelector('.button-text');
        const buttonSpinner = submitBtn.querySelector('.button-spinner');

        // Show loading state
        submitBtn.disabled = true;
        buttonText.style.display = 'none';
        buttonSpinner.style.display = 'inline-flex';

        try {
            const response = await fetch(`/api/drops/${dropId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                showSuccessBanner('Drop updated successfully!');
                // Update the drop data in memory if needed
                if (result.data) {
                    // Update any displayed data with the latest from server
                    console.log('Drop updated:', result.data);
                }
            } else {
                showErrorBanner(result.message || 'Failed to update drop');
            }
        } catch (error) {
            showErrorBanner('Network error. Please try again.');
        } finally {
            submitBtn.disabled = false;
            buttonText.style.display = 'inline';
            buttonSpinner.style.display = 'none';
        }
    });

    function showError(message) {
        const errorDiv = document.getElementById('edit-error');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => errorDiv.style.display = 'none', 5000);
    }

    function showSuccess(message) {
        const successDiv = document.getElementById('edit-success');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        setTimeout(() => successDiv.style.display = 'none', 5000);
    }

    // Enhanced banner functions for better UX
    function showSuccessBanner(message) {
        createBanner(message, 'success');
    }

    function showErrorBanner(message) {
        createBanner(message, 'error');
    }

    function createBanner(message, type) {
        // Remove any existing banners
        const existingBanners = document.querySelectorAll('.notification-banner');
        existingBanners.forEach(banner => banner.remove());

        // Create new banner
        const banner = document.createElement('div');
        banner.className = `notification-banner ${type}`;
        banner.innerHTML = `
            <div class="banner-content">
                <div class="banner-icon">
                    ${type === 'success' ? '✅' : '❌'}
                </div>
                <div class="banner-message">${message}</div>
                <button class="banner-close" onclick="this.parentElement.parentElement.remove()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
        `;

        // Add to page
        document.body.appendChild(banner);

        // Animate in
        setTimeout(() => banner.classList.add('show'), 100);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            banner.classList.remove('show');
            setTimeout(() => banner.remove(), 300);
        }, 5000);
    }
});
</script>
