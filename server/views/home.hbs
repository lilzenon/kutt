<!-- Main Container -->
<div class="figma-home-container">
    <!-- Header Section with BOUNCE2BOUNCE Logo -->
    <header class="figma-header">
        <div class="figma-logo-container">
            <svg class="figma-logo" viewBox="0 0 3784.75 1161.8" xmlns="http://www.w3.org/2000/svg">
                <path d="M162.87,658.37c39.48.14,79.1-.14,118.58,0,0,41.61-9.47,60.49-25.25,102.1,80.41-45.97,220.81-67.25,274.26,7.28,40.36,48.32-28.97,173.84-65.7,228.53-28.63,42.97-51.43,72.73-93.37,95.25-69.33,37.1-199.33,35.47-247.04-20.71-2.88,14.1-4.83,28.19-5.64,42.29-39.57.13-79.15.27-118.72.4,9.13-159.43,162.87-295.71,162.87-455.14ZM189.97,891.75c-8.96,17.92-17.84,35.84-26.21,53.77,2.2,52.05,40.5,47.39,91.53,50.17,66.96,2.17,113.65-43.58,134.33-106.01,6.04-16.18,6.61-30.36-1.82-43.78-11.87-12.79-31.76-12.32-48.48-12.6-69.37-.05-118.88,19.43-149.34,58.45ZM830.6,718.26c75.06-1.62,181.75,17.46,163.81,114.56-18.44,83.93-78.18,190.32-147.47,240.35-75.25,53.79-247.76,62.61-318.22.22-64.06-64.91,9.31-178.01,54.84-239.18,60.76-81.27,148.31-118.45,247.05-115.95ZM708.51,1005.11c64.54-.84,101.27-27.47,130.75-87.79,12.3-26.42,21.59-53.38,2.59-72.13-21.36-17.63-49.74-18.5-76.83-13.89-31.84,6.27-61.51,22.69-83.67,48.61-42.97,50.77-64.03,128.87,27.15,125.2ZM1384.85,720.64c39.48.09,78.97.19,118.45.28-36.1,129.34-141.44,258.68-148.84,388.02-39.57.13-79.15.27-118.72.4,1.14-19.88,4.59-39.76,9.74-59.65-39.81,39.39-82.51,59.22-139.6,59.41-77.41-2.33-141.29-9.57-145.58-92.33,3.39-97.12,72.42-177.95,107.37-296.9,39.32.09,78.63.19,117.95.28-13.64,50.37-42.12,107.42-65.83,155.77-8.9,20.05-21.79,47.98-18.48,70.82,1.32,16.83,10.2,22.12,25.24,28.47,58.68,15.08,105.33-9.6,171.09-56.43,32.3-66.05,68.76-132.11,87.2-198.16ZM1887.14,800.5c-13.33,95.98-90.05,176.17-100.98,306.98-39.57.13-79.15.27-118.72.4,2.5-49.93,22.38-105.22,44.15-152.65,9.88-23.12,24.14-53.69,24.99-79.15.38-28.53-18.88-38.32-46.01-38.29-46.39-.09-75.35,18.8-112.07,47.28-37.28,74.46-74.07,148.92-78.34,223.38-39.57.13-79.14.27-118.72.4,7.4-129.29,112.7-258.58,148.78-387.86,39.48.09,78.97.19,118.45.28-4.98,17.83-11.27,35.66-18.45,53.5,36.55-24.3,61.45-42.87,103.21-52.63,59.32-9.89,166.18-8.29,153.7,78.36ZM2161.64,721.47c93.02-2.34,214.33,34.77,159.5,145.62-43.45,7.68-86.94,15.38-130.42,23.1,12.23-67.21-110.77-54.77-146.27-33.1-23.92,13.73-41.48,34.6-52.99,58.96-28.91,54.87.36,78.59,57.67,77.36,43.81.32,90.72-13.33,116.2-49.05,36.01,7.01,72.12,14.01,108.33,20.99-55.21,133.9-209.3,165.79-339.94,136.19-98.16-23.82-105.76-104.75-63-184.77,63.8-120.73,149.21-196.24,290.92-195.31ZM330.42,159.13c39.4.14,78.81.28,118.21.42,0,41.51-10.66,83.03-26.54,124.54,80.29-45.79,220.48-67.19,273.73,7.26,40.13,48.2-29.5,173.45-66.04,228-28.52,42.84-51.1,72.54-92.87,95.04-69.24,37.13-198.88,35.27-246.7-20.66-2.81,14.06-4.67,28.13-5.36,42.19-39.5.13-79,.27-118.5.4,7.89-159.06,164.06-318.13,164.06-477.19ZM360.11,416.79c-9,17.92-17.9,35.84-26.25,53.76,2.28,52.03,40.64,47.39,91.67,50.17,66.98,2.18,113.44-43.64,134.23-106,6.07-16.16,6.71-30.34-1.68-43.78-11.84-12.8-31.72-12.31-48.43-12.59-69.36-.05-118.99,19.42-149.55,58.45ZM999.38,241.88c74.99-1.64,181.75,17.46,163.44,114.55-18.77,83.73-78.36,190.14-147.36,240.33-75.9,59.79-343.04,73.77-343.69-61.25-1.34-52.36,44.71-134.69,80.19-177.69,61.01-81.19,148.58-118.44,247.42-115.95ZM876.7,528.71c64.57-.84,101.16-27.48,130.74-87.79,12.33-26.4,21.73-53.33,2.79-72.13-21.32-17.64-49.71-18.49-76.78-13.88-31.88,6.28-61.6,22.69-83.83,48.61-43.13,50.74-64.16,128.86,27.08,125.19ZM1554.98,245.22c38.91.09,77.81.18,116.72.28-36.7,129.19-142.79,258.38-148.5,387.56-38.99.13-77.98.27-116.97.4.88-19.86,4.12-39.72,9.12-59.58-39.44,39.35-81.77,59.16-138.78,59.35-77.31-2.32-141.41-9.6-146.14-92.22,3-97.14,72.42-177.79,107.9-296.54,38.91.09,77.81.18,116.72.28-13.89,50.37-42.69,107.4-66.55,155.76-8.95,20.03-21.89,47.96-18.52,70.81,1.37,16.86,10.33,22.12,25.42,28.47,58.88,15.08,105.62-9.58,171.58-56.43,32.36-66.05,69.23-132.09,87.99-198.14ZM2055.56,325.49c-13.64,95.54-90.7,175.57-100.08,306.09-39.5.13-79,.27-118.5.4,1.83-49.93,21.48-105.26,43.21-152.64,9.87-23.14,24.18-53.69,25.13-79.15.5-28.48-18.59-38.32-45.7-38.29-46.31-.09-75.28,18.84-111.98,47.28-37.48,74.45-74.18,148.91-77.48,223.36-39.84.14-79.68.27-119.51.41,5.7-128.91,111.39-257.83,148.25-386.74,39.75.09,79.5.19,119.25.28-5.08,17.78-11.48,35.56-18.74,53.34,36.6-24.22,61.55-42.74,103.3-52.48,59.06-9.84,165.81-8.36,152.85,78.12ZM2614.63,713.55c174.97.18,185.08,96.8,105.99,235.07-100.63.1-201.26.2-301.88.31-14.92,73.64,206.18,27,241.79,13.52,1.27,35.38,5.27,70.74,15.54,106.07-74.54,39.08-286.34,54.41-355.6.35-51.86-42.03-31.04-105.61-3.56-160.7,63.57-120.76,156.77-195.66,297.73-194.62ZM2568.74,834.62c-46.02-.14-95.97,11.27-119.01,50.61,60.62,0,121.24,0,181.86-.01,16.99-41.9-15.83-50.06-62.85-50.6ZM2326.82,243.29c93.02-2.34,214.33,34.77,159.5,145.62-43.45,7.68-86.94,15.38-130.42,23.1,12.23-67.21-110.77-54.77-146.27-33.1-23.92,13.73-41.48,34.6-52.99,58.96-28.91,54.87.36,78.59,57.67,77.36,43.81.32,90.72-13.33,116.2-49.05,36.01,7.01,72.12,14.01,108.33,20.99-55.21,133.9-209.3,165.79-339.94,136.19-98.16-23.82-105.76-104.75-63-184.77,63.8-120.73,149.21-196.24,290.92-195.31ZM2779.81,235.37c174.97.18,185.08,96.8,105.99,235.07-100.63.1-201.26.2-301.88.31-14.92,73.64,206.18,27,241.79,13.52,1.27,35.38,5.27,70.74,15.54,106.07-74.54,39.08-286.34,54.41-355.6.35-51.86-42.03-31.04-105.61-3.56-160.7,63.57-120.76,156.77-195.66,297.73-194.62ZM2733.93,356.44c-46.02-.14-95.97,11.27-119.01,50.61,60.62,0,121.24,0,181.86-.01,16.99-41.9-15.83-50.06-62.85-50.6ZM2269.4,1023.85c-14.22,21.01-75.88,115.1-90.98,137.95,40.57-12.22,134.31-43.94,175.91-52.63-43.26-13.61-76.99-41.67-84.94-85.33M2759.65,641.68c-45.32,6.97-97.16,10.21-146.67,8.82-11.91,13.12-22.26,27.97-33.83,42.42,36-3.13,81.51-1.08,112.61,6.74,21.34-22.81,43.94-41.77,67.89-57.97M3340.83,359.43l.04.03s-.03-.02-.04-.03M3193.79,230.91c-81.07.64-172.88,19.15-249.48,56.57,15.3,27.54,12.22,71.44.11,106.27,102.25-70.18,296.4-104.02,400.66-31.18-18.11,18.61-50.8,35.37-77.15,42.52h.03c-118.98,32.99-243.05,44.28-362.21,75.64-.17.32-.33.64-.5.96-4.41.99-8.84,1.95-13.23,3.05l.05.05c-2.27.51-4.57,1.04-6.82,1.58v-.06c-.09.02-.36.1-.44.13h0c-.45.11-1.09.34-1.54.48h.25c-2.93.86-5.86,1.72-8.77,2.61h0c-9.4,2.84-18.76,5.84-28.07,9.03,2,34.93,7.15,63.67,15.57,91.48,152.71-63.91,425.2-51.51,543.07-158.47,52.7-48.09,48.58-106.99-11.08-146.34-56.78-40.33-129.43-54.2-200.43-54.3M3387.08,1065.37h0M3382.23,1051.72h13.79-13.79M3382.69,1047.4h0M2837.5,721.51h0M2839.28,721.28h0M3313.99,0c-25.46,0-50.37.74-74.3,2h.07c-206.6,10.39-379.08,70.65-528.98,200.69l.17-.15c-11.55,9.92-23.47,19.65-35.58,29.54,46.74-14.39,109.47-17.71,159.48-10.17,138.29-96.68,300.71-130.77,479.14-130.49,131.62,3.94,289.87,10.87,361.94,129.69,59.37,120.08-45.97,215.84-148.63,277.62l.03-.02c-154.9,91.21-292.98,96.41-466.1,159.86-81.64,23.45-152.7,44.6-224.61,63.09h0c2.01,9.08,5.39,27.44,6.61,36.61,0,0,.27,2.49.27,2.49l.47,51.7c.21,0,.41,0,.6,0h0c217.61-3.4,435.2-6.74,652.76-10.01-28.9,57.59-57.32,115.46-83.93,173.65-48.75-19.19-92.25-23.53-152.33-28.95-177.19-11.59-364.3-.76-552.02,17.61v-.03c-5.27.46-9.89,1.02-15.3,1.55h0c-3.52.31-7.03.65-10.54,1.1l.09.44-.54.08c.03.46.13,1.4.21,1.85h-.41c1.66,33.45,5.87,61.69,13.09,87.91,211.57-19.31,415.24-36.03,615.14-13.32,28.55,4.89,53.88,7.75,76.27,21.03l9.1-9.61,4.9-2.39,68.2,22.14c51.65-120.27,116.97-246.24,177.9-366.74-154.79,2.32-311.08,4.67-465.75,7.04,210.42-55,495.09-121.86,588.7-344.76,23.62-63.26,18.16-131.18-12.99-191.91C3672.33,24.22,3473.4,1.68,3313.99,0"/>
            </svg>
        </div>
    </header>

    <!-- Event Card Carousel Section -->
    <main class="figma-main">
        <div class="carousel-container" role="region" aria-label="Event carousel">
            <!-- Carousel Track -->
            <div class="carousel-track" id="carouselTrack">
                <!-- Home Settings Event Card (Always First) -->
                {{#if homeSettings.event_title}}
                <div class="figma-event-card carousel-slide" data-slide="0">
                    <!-- Event Image with Gradient Background -->
                    <div class="figma-event-image">
                        {{#if homeSettings.event_image}}
                            <img src="{{homeSettings.event_image}}" alt="{{homeSettings.event_title}}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 20px;" />
                        {{else}}
                            <div class="figma-image-placeholder">
                                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor" opacity="0.4"/>
                                </svg>
                            </div>
                        {{/if}}
                    </div>

                    <!-- Event Information -->
                    <div class="figma-event-info">
                        <h1 class="figma-event-title">{{homeSettings.event_title}}</h1>
                        <div class="figma-event-artist">{{homeSettings.artist_name}}</div>
                        <div class="figma-event-date">📅 {{formattedDate}}</div>
                        <div class="figma-event-address">📍 {{homeSettings.event_address}}</div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="figma-action-buttons">
                        <button class="figma-share-btn" data-share-url="{{homeSettings.tickets_url}}">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 12L8 21L16 21L16 12" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 16L12 3" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M8 7L12 3L16 7" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="figma-tickets-btn" data-tickets-url="{{homeSettings.tickets_url}}">Tickets</button>
                    </div>
                </div>
                {{/if}}

                <!-- 🚀 DEBUG: Featured Drops Data -->
                <script>
                    console.log('🎯 Template Debug - Featured Drops:', {{{json featuredDrops}}});
                    console.log('🎯 Template Debug - Featured Drops Length:', {{featuredDrops.length}});
                </script>

                <!-- Featured Drops Cards -->
                {{#each featuredDrops}}
                <div class="figma-event-card carousel-slide" data-slide="{{math @index '+' 1}}">
                    <!-- Event Image with Gradient Background -->
                    <div class="figma-event-image">
                        {{#if this.cover_image}}
                            <img src="{{this.cover_image}}" alt="{{this.title}}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 20px;" />
                        {{else}}
                            <div class="figma-image-placeholder" style="{{#if this.gradient_data}}background: {{parseGradientData this.gradient_data}};{{else if this.background_color}}background: {{this.background_color}};{{else}}background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);{{/if}}">
                                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                        {{/if}}
                    </div>

                    <!-- Event Information -->
                    <div class="figma-event-info">
                        <h1 class="figma-event-title">{{this.title}}</h1>
                        {{#if this.artist_name}}
                        <h2 class="figma-event-artist">{{this.artist_name}}</h2>
                        {{/if}}
                        {{#if this.event_date}}
                        <p class="figma-event-date">{{formatDate this.event_date "MMMM do, h:mm a"}}</p>
                        {{/if}}
                        {{#if this.event_address}}
                        <p class="figma-event-address">{{this.event_address}}</p>
                        {{/if}}
                        {{#if this.description}}
                        <p class="figma-event-description">{{this.description}}</p>
                        {{/if}}
                    </div>

                    <!-- Action Buttons -->
                    <div class="figma-action-buttons">
                        <button class="figma-btn figma-btn-primary" onclick="window.open('/drop/{{this.slug}}', '_blank')">
                            <span>{{#if this.button_text}}{{this.button_text}}{{else}}Get Notified{{/if}}</span>
                        </button>
                        <button class="figma-btn figma-btn-secondary drop-share-btn" data-drop-title="{{this.title}}" data-drop-slug="{{this.slug}}">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Share</span>
                        </button>
                    </div>
                </div>
                {{else}}
                <!-- 🚀 DEBUG: No Featured Drops Found -->
                <div class="figma-event-card carousel-slide" data-slide="1" style="background: #ff6b6b; color: white; padding: 20px; text-align: center;">
                    <h2>🔍 DEBUG: No Featured Drops</h2>
                    <p>No drops found with show_on_homepage=true</p>
                    <p>Total drops in template: {{featuredDrops.length}}</p>
                    <p>Check /api/home-settings/debug-drops for details</p>
                </div>
                {{/each}}
            </div>

            <!-- Carousel Navigation -->
            <div class="carousel-nav">
                <!-- Previous/Next Buttons (Desktop) -->
                <button class="carousel-btn carousel-prev" id="carouselPrev" aria-label="Previous event">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button class="carousel-btn carousel-next" id="carouselNext" aria-label="Next event">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>

                <!-- Dot Indicators (Generated Dynamically by JavaScript) -->
                <div class="carousel-indicators" role="tablist" aria-label="Event navigation" id="carouselIndicators">
                    <!-- Dots will be generated by JavaScript to ensure correct indexing -->
                </div>
            </div>
        </div>
    </main>

    <!-- Text Us Section -->
    <section class="figma-text-us">
        <div class="figma-text-us-content">
            <h2 class="figma-text-us-title">Text us</h2>
            <p class="figma-text-us-subtitle">Exclusive events, contests, and more</p>

            <!-- Phone Input Container with Live Drop Design -->
            <div class="figma-phone-container">
                <div class="phone-input-container">
                    <!-- Native Country Select -->
                    <div class="phone-country-select">
                        <div class="country-select-wrapper">
                            <div class="country-flag-display" id="country-flag-display">
                                <img alt="United States" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjEiIGhlaWdodD0iMTUiIHZpZXdCb3g9IjAgMCAyMSAxNSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjIxIiBoZWlnaHQ9IjE1IiBmaWxsPSIjQjIyMjM0Ii8+CjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNMCAwSDIxVjFIMFYwWk0wIDJIMjFWM0gwVjJaTTAgNEgyMVY1SDBWNFpNMCA2SDIxVjdIMFY2Wk0wIDhIMjFWOUgwVjhaTTAgMTBIMjFWMTFIMFYxMFpNMCAxMkgyMVYxM0gwVjEyWiIgZmlsbD0id2hpdGUiLz4KPHJlY3Qgd2lkdGg9IjkiIGhlaWdodD0iOCIgZmlsbD0iIzNDM0I2RSIvPgo8L3N2Zz4K" />
                            </div>
                            <select class="country-select" id="country-select" name="country_code" aria-label="Select country code">
                                <option value="+1" data-country="US" data-name="United States">US +1 United States</option>
                                <option value="+44" data-country="GB" data-name="United Kingdom">GB +44 United Kingdom</option>
                                <option value="+1" data-country="CA" data-name="Canada">CA +1 Canada</option>
                                <option value="+61" data-country="AU" data-name="Australia">AU +61 Australia</option>
                                <option value="+49" data-country="DE" data-name="Germany">DE +49 Germany</option>
                                <option value="+33" data-country="FR" data-name="France">FR +33 France</option>
                                <option value="+39" data-country="IT" data-name="Italy">IT +39 Italy</option>
                                <option value="+34" data-country="ES" data-name="Spain">ES +34 Spain</option>
                                <option value="+31" data-country="NL" data-name="Netherlands">NL +31 Netherlands</option>
                                <option value="+46" data-country="SE" data-name="Sweden">SE +46 Sweden</option>
                                <option value="+47" data-country="NO" data-name="Norway">NO +47 Norway</option>
                                <option value="+45" data-country="DK" data-name="Denmark">DK +45 Denmark</option>
                                <option value="+41" data-country="CH" data-name="Switzerland">CH +41 Switzerland</option>
                                <option value="+43" data-country="AT" data-name="Austria">AT +43 Austria</option>
                                <option value="+32" data-country="BE" data-name="Belgium">BE +32 Belgium</option>
                                <option value="+81" data-country="JP" data-name="Japan">JP +81 Japan</option>
                                <option value="+82" data-country="KR" data-name="South Korea">KR +82 South Korea</option>
                                <option value="+55" data-country="BR" data-name="Brazil">BR +55 Brazil</option>
                                <option value="+52" data-country="MX" data-name="Mexico">MX +52 Mexico</option>
                                <option value="+91" data-country="IN" data-name="India">IN +91 India</option>
                                <option value="+86" data-country="CN" data-name="China">CN +86 China</option>
                            </select>
                        </div>
                    </div>

                    <!-- International Phone Input Field -->
                    <input
                        type="tel"
                        name="phone"
                        placeholder="(555) 123-4567"
                        class="phone-input-field"
                        id="phoneInput"
                        value=""
                        maxlength="20"
                        autocomplete="tel"
                        aria-label="Phone number"
                        aria-describedby="phone-validation-message"
                        aria-invalid="false"
                        required
                    />

                    <!-- Validation Icons -->
                    <div class="validation-icon success" aria-hidden="true">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="validation-icon error" aria-hidden="true">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <line x1="15" y1="9" x2="9" y2="15" stroke="currentColor" stroke-width="2"/>
                            <line x1="9" y1="9" x2="15" y2="15" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </div>
                    <div class="validation-icon loading" aria-hidden="true">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 12a9 9 0 11-6.219-8.56" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>

                    <!-- Inlaid Send Button -->
                    <button type="submit" class="laylo-rsvp-button inlaid" id="sendBtn" name="send" alt="Send Message" title="Send Message">
                        SEND
                    </button>
                </div>

                <!-- Validation Message -->
                <div id="phone-validation-message" class="validation-message" role="alert" aria-live="polite" aria-atomic="true"></div>
            </div>

            <!-- Disclaimer Text -->
            <p class="figma-disclaimer">
                By submitting my information, I agree to receive recurring automated messages to the contact information provided and to
                <a href="https://terms.bounce2bounce.com" target="_blank">Terms of Service</a>,
                <a href="https://terms.bounce2bounce.com" target="_blank">Cookie Policy</a> and
                <a href="https://terms.bounce2bounce.com" target="_blank">Privacy Policy</a>.
                Msg & Data Rates may apply. Reply STOP to cancel, HELP for help.
            </p>
        </div>
    </section>

    <!-- Footer Section -->
    <footer class="figma-footer">
        <div class="figma-social-icons">
            {{#if homeSettings.instagram_url}}
            <a href="{{homeSettings.instagram_url}}" class="figma-social-link" aria-label="Instagram" target="_blank" rel="noopener noreferrer">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                </svg>
            </a>
            {{/if}}
            {{#if homeSettings.tiktok_url}}
            <a href="{{homeSettings.tiktok_url}}" class="figma-social-link" aria-label="TikTok" target="_blank" rel="noopener noreferrer">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-5.2 1.74 2.89 2.89 0 012.31-4.64 2.93 2.93 0 01.88.13V9.4a6.84 6.84 0 00-.88-.05A6.33 6.33 0 005 20.1a6.34 6.34 0 0010.86-4.43v-7a8.16 8.16 0 004.77 1.52v-3.4a4.85 4.85 0 01-1-.1z"/>
                </svg>
            </a>
            {{/if}}
            {{#if homeSettings.twitter_url}}
            <a href="{{homeSettings.twitter_url}}" class="figma-social-link" aria-label="Twitter" target="_blank" rel="noopener noreferrer">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                </svg>
            </a>
            {{/if}}
            {{#if homeSettings.email_url}}
            <a href="{{homeSettings.email_url}}" class="figma-social-link" aria-label="Email" target="_blank" rel="noopener noreferrer">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                </svg>
            </a>
            {{/if}}
        </div>
    </footer>

    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <button class="modal-close" id="modalClose">&times;</button>
            <div class="modal-iframe-container">
                <iframe
                    id="poshIframe"
                    src="{{homeSettings.tickets_url}}"
                    width="100%"
                    height="600px"
                    style="border: none;"
                    loading="lazy"
                    title="Ticket Checkout">
                </iframe>
            </div>
        </div>
    </div>

    <!-- Glassmorphism Navigation Bar -->
    <div class="navbar-container">
        <nav class="modern-navbar">
            <a href="#" class="nav-item selected" data-nav="home">Home</a>
            <a href="#" class="nav-item contact" data-nav="contact">Contact</a>
        </nav>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const navItems = document.querySelectorAll('.nav-item');
    const ticketsBtn = document.getElementById('ticketsBtn');
    const shareBtn = document.getElementById('shareBtn');
    const sendBtn = document.getElementById('sendBtn');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalClose = document.getElementById('modalClose');
    const phoneInput = document.getElementById('phoneInput');
    const countrySelect = document.getElementById('country-select');
    const countryFlagDisplay = document.getElementById('country-flag-display');

    // Carousel elements
    const carouselTrack = document.getElementById('carouselTrack');
    const carouselPrev = document.getElementById('carouselPrev');
    const carouselNext = document.getElementById('carouselNext');
    let carouselDots = []; // Will be populated after dots are generated

    // Debug element selection
    console.log('🔍 Element Debug:', {
        carouselTrack: !!carouselTrack,
        carouselTrackElement: carouselTrack,
        carouselPrev: !!carouselPrev,
        carouselNext: !!carouselNext,
        carouselDotsCount: carouselDots.length,
        totalSlides: totalSlides
    });

    // Carousel track validation
    if (!carouselTrack) {
        console.error('❌ Carousel track NOT found! Touch functionality will not work.');
        return;
    }

    // Handle dynamic share and tickets buttons
    document.addEventListener('click', function(e) {
        // Handle share buttons
        if (e.target.closest('.figma-share-btn')) {
            const shareBtn = e.target.closest('.figma-share-btn');
            const shareUrl = shareBtn.getAttribute('data-share-url');

            if (shareUrl) {
                if (navigator.share) {
                    navigator.share({
                        title: 'Check out this event!',
                        url: shareUrl
                    }).catch(console.error);
                } else {
                    // Fallback: copy to clipboard
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        console.log('✅ URL copied to clipboard');
                        // You could show a toast notification here
                    }).catch(console.error);
                }
            }
        }

        // Handle tickets/drop buttons
        if (e.target.closest('.figma-tickets-btn')) {
            const ticketsBtn = e.target.closest('.figma-tickets-btn');
            const ticketsUrl = ticketsBtn.getAttribute('data-tickets-url');
            const dropUrl = ticketsBtn.getAttribute('data-drop-url');

            if (ticketsUrl) {
                // Open tickets modal for home settings
                if (modalOverlay) {
                    modalOverlay.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
            } else if (dropUrl) {
                // Navigate to drop page
                window.location.href = dropUrl;
            }
        }
    });

    // JavaScript loaded successfully

    // Navigation functionality
    navItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();

            // Add click animation class
            this.classList.add('clicking');

            // Remove selected state from all items
            navItems.forEach(navItem => {
                navItem.classList.remove('selected');
            });

            // Add selected state to clicked item
            this.classList.add('selected');

            // Remove click animation after animation completes
            setTimeout(() => {
                this.classList.remove('clicking');
            }, 200);
        });
    });

    // Carousel functionality
    let currentSlide = 0;
    let totalSlides = document.querySelectorAll('.carousel-slide').length;
    let isTransitioning = false;

    // Carousel initialization moved to initializeCarousel() function

    // Generate carousel dots dynamically to ensure correct indexing
    function generateCarouselDots() {
        const indicatorsContainer = document.getElementById('carouselIndicators');
        if (!indicatorsContainer) {
            console.error('❌ Carousel indicators container not found!');
            return;
        }

        // Clear existing dots
        indicatorsContainer.innerHTML = '';

        // Generate dots for each slide
        for (let i = 0; i < totalSlides; i++) {
            const dot = document.createElement('button');
            dot.className = `carousel-dot${i === 0 ? ' active' : ''}`;
            dot.setAttribute('data-slide', i.toString());
            dot.setAttribute('role', 'tab');
            dot.setAttribute('aria-selected', i === 0 ? 'true' : 'false');
            dot.setAttribute('aria-label', `Slide ${i + 1}`);

            // Add click event listener
            dot.addEventListener('click', () => {
                updateCarousel(i);
            });

            indicatorsContainer.appendChild(dot);
        }

        console.log(`🎯 Generated ${totalSlides} carousel dots with correct indexing`);

        // Update carouselDots array
        carouselDots = document.querySelectorAll('.carousel-dot');
        console.log(`🏠 Homepage loaded with ${totalSlides} total slides`);
    }

    // 🚀 CAROUSEL REINITIALIZATION FOR DYNAMIC CARD UPDATES
    function reinitializeCarousel(newTotalSlides) {
        console.log(`🔄 Reinitializing carousel: ${totalSlides} → ${newTotalSlides} slides`);

        const oldTotalSlides = totalSlides;
        totalSlides = newTotalSlides;

        // Update carousel track width
        if (carouselTrack && totalSlides > 0) {
            const trackWidth = totalSlides * 100;
            carouselTrack.style.width = `${trackWidth}%`;
            console.log(`🎨 Updated carousel track width to ${trackWidth}%`);
        }

        // Regenerate dots
        generateCarouselDots();

        // Adjust current slide if necessary
        if (currentSlide >= totalSlides) {
            currentSlide = Math.max(0, totalSlides - 1);
            console.log(`📍 Adjusted current slide to ${currentSlide}`);
        }

        // Update carousel position
        updateCarousel(currentSlide, false);

        console.log(`✅ Carousel reinitialized successfully`);
    }

    // 🚀 REFRESH HOMEPAGE CARDS FROM SERVER
    async function refreshHomepageCards() {
        try {
            console.log('🔄 Refreshing homepage cards from server...');

            const response = await fetch('/api/home-settings/refresh');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            console.log('📦 Received homepage data:', data);

            // Update the carousel with new data
            await updateCarouselWithNewData(data);

            console.log('✅ Homepage cards refreshed successfully');
        } catch (error) {
            console.error('❌ Failed to refresh homepage cards:', error);
        }
    }

    // 🚀 UPDATE CAROUSEL WITH NEW DATA
    async function updateCarouselWithNewData(data) {
        const { homeSettings, featuredDrops, formattedDate, totalCards } = data;

        console.log(`🎯 Updating carousel with ${totalCards} total cards`);

        // Get carousel track
        const track = document.getElementById('carouselTrack');
        if (!track) {
            console.error('❌ Carousel track not found');
            return;
        }

        // Clear existing slides
        track.innerHTML = '';

        // Add home settings card (always first)
        if (homeSettings.event_title) {
            const homeCard = createHomeSettingsCard(homeSettings, formattedDate);
            track.appendChild(homeCard);
        }

        // Add featured drops cards
        featuredDrops.forEach((drop, index) => {
            const dropCard = createDropCard(drop, index + 1);
            track.appendChild(dropCard);
        });

        // Reinitialize carousel
        reinitializeCarousel(totalCards);
    }

    // Initialize carousel after DOM elements are ready
    function initializeCarousel() {
        // Recalculate totalSlides from actual DOM elements
        totalSlides = document.querySelectorAll('.carousel-slide').length;
        console.log(`🎠 Carousel initialized with ${totalSlides} slides`);

        // Set carousel track width dynamically based on number of slides
        if (carouselTrack && totalSlides > 0) {
            const trackWidth = totalSlides * 100; // Each slide is 100% of container width
            carouselTrack.style.width = `${trackWidth}%`;
            console.log(`🎨 Set carousel track width to ${trackWidth}% for ${totalSlides} slides`);
        }

        // Generate dots after totalSlides is properly set
        generateCarouselDots();
    }

    // Initialize carousel after a short delay to ensure DOM is ready
    setTimeout(initializeCarousel, 100);

    // Update carousel position
    function updateCarousel(slideIndex, animate = true) {
        if (isTransitioning && animate) return;

        currentSlide = Math.max(0, Math.min(slideIndex, totalSlides - 1));
        const translateX = -currentSlide * 100;

        // Ensure transition is properly set
        if (animate && !window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
            isTransitioning = true;
            carouselTrack.style.transition = 'transform 300ms cubic-bezier(0.4, 0, 0.2, 1)';
            carouselTrack.style.transform = `translateX(${translateX}%)`;

            setTimeout(() => {
                isTransitioning = false;
            }, 300);
        } else {
            carouselTrack.style.transition = 'none';
            carouselTrack.style.transform = `translateX(${translateX}%)`;
            if (!animate) {
                // Restore transition after immediate positioning
                setTimeout(() => {
                    carouselTrack.style.transition = 'transform 300ms cubic-bezier(0.4, 0, 0.2, 1)';
                }, 10);
            }
        }

        // Update dot indicators
        carouselDots.forEach((dot, index) => {
            dot.classList.toggle('active', index === currentSlide);
            dot.setAttribute('aria-selected', index === currentSlide ? 'true' : 'false');
        });

        // Update ARIA attributes
        const slides = document.querySelectorAll('.carousel-slide');
        slides.forEach((slide, index) => {
            slide.setAttribute('aria-hidden', index !== currentSlide ? 'true' : 'false');
        });
    }

    // Previous slide
    function prevSlide() {
        console.log('🔙 prevSlide() called - currentSlide:', currentSlide);
        if (currentSlide > 0) {
            console.log('✅ Moving to slide:', currentSlide - 1);
            updateCarousel(currentSlide - 1);
        } else {
            console.log('❌ Already at first slide, cannot go back');
        }
    }

    // Next slide
    function nextSlide() {
        console.log('🔜 nextSlide() called - currentSlide:', currentSlide);
        if (currentSlide < totalSlides - 1) {
            console.log('✅ Moving to slide:', currentSlide + 1);
            updateCarousel(currentSlide + 1);
        } else {
            console.log('❌ Already at last slide, cannot go forward');
        }
    }

    // Mobile browser optimized touch handling
    let startX = 0;
    let startY = 0;
    let currentX = 0;
    let currentY = 0;
    let isDragging = false;
    let isHorizontalSwipe = false;
    let startTime = 0;

    function handleTouchStart(e) {
        console.log('🚀 TOUCH START EVENT FIRED!', e);

        if (!e.touches || e.touches.length === 0) {
            console.error('❌ No touches found in touchstart event');
            return;
        }

        // iOS Safari Fix: Only handle single touch
        if (e.touches.length > 1) {
            console.log('🚫 Multi-touch detected, ignoring');
            return;
        }

        const touch = e.touches[0];
        startX = touch.clientX;
        startY = touch.clientY;
        currentX = startX;
        currentY = startY;
        isDragging = true;
        isHorizontalSwipe = false;
        startTime = Date.now();

        console.log('🚀 Touch Start Data:', {
            startX: startX,
            startY: startY,
            currentSlide: currentSlide,
            totalSlides: totalSlides,
            touchesLength: e.touches.length,
            target: e.target,
            touchClientX: touch.clientX,
            touchClientY: touch.clientY,
            userAgent: navigator.userAgent.includes('Safari') ? 'Safari' : 'Other'
        });

        // Disable transitions for immediate feedback
        carouselTrack.style.transition = 'none';

        // iOS Safari Fix: Add touch-action CSS to prevent default behaviors
        carouselTrack.style.touchAction = 'pan-y pinch-zoom';
    }

    function handleTouchMove(e) {
        console.log('🔄 TOUCH MOVE EVENT FIRED!', {
            isDragging: isDragging,
            touchesLength: e.touches ? e.touches.length : 0
        });

        if (!isDragging) {
            console.log('❌ Not dragging, returning');
            return;
        }

        if (!e.touches || e.touches.length === 0) {
            console.error('❌ No touches found in touchmove event');
            return;
        }

        // iOS Safari Fix: Only handle single touch
        if (e.touches.length > 1) {
            console.log('🚫 Multi-touch detected during move, cancelling');
            isDragging = false;
            carouselTrack.style.transition = 'transform 300ms cubic-bezier(0.4, 0, 0.2, 1)';
            updateCarousel(currentSlide);
            return;
        }

        const touch = e.touches[0];
        currentX = touch.clientX;
        currentY = touch.clientY;

        const deltaX = currentX - startX;
        const deltaY = currentY - startY;

        console.log('📏 Touch Move Delta:', {
            deltaX: deltaX,
            deltaY: deltaY,
            absDeltaX: Math.abs(deltaX),
            absDeltaY: Math.abs(deltaY),
            startX: startX,
            currentX: currentX,
            isHorizontalSwipe: isHorizontalSwipe
        });

        // iOS Safari Fix: Enhanced horizontal detection with better thresholds
        const absDeltaX = Math.abs(deltaX);
        const absDeltaY = Math.abs(deltaY);

        // Detect horizontal swipe with iOS Safari optimized thresholds
        if (!isHorizontalSwipe) {
            // More sensitive horizontal detection for iOS Safari
            if (absDeltaX > 3 && (absDeltaY === 0 || absDeltaX / absDeltaY > 1.5)) {
                isHorizontalSwipe = true;
                console.log('🔄 Horizontal swipe detected (iOS Safari optimized):', {
                    deltaX: deltaX,
                    deltaY: deltaY,
                    absDeltaX: absDeltaX,
                    absDeltaY: absDeltaY,
                    ratio: absDeltaY > 0 ? absDeltaX / absDeltaY : 'infinite'
                });
            }
        }

        // iOS Safari: Prevent default and apply drag effect for horizontal swipes
        if (isHorizontalSwipe) {
            e.preventDefault();
            e.stopPropagation();

            console.log('✅ Processing horizontal swipe');

            const currentTranslate = -currentSlide * 100;
            const dragPercent = (deltaX / carouselTrack.offsetWidth) * 100;

            // Apply drag effect with resistance at boundaries
            let newTranslate = currentTranslate + dragPercent;

            // Add resistance at boundaries with iOS Safari optimized values
            if (newTranslate > 0) {
                newTranslate = newTranslate * 0.25; // Stronger resistance
            } else if (newTranslate < -(totalSlides - 1) * 100) {
                const excess = newTranslate + (totalSlides - 1) * 100;
                newTranslate = -(totalSlides - 1) * 100 + excess * 0.25; // Stronger resistance
            }

            carouselTrack.style.transform = `translateX(${newTranslate}%)`;
            console.log('🎨 Applied transform:', `translateX(${newTranslate}%)`);
        } else {
            console.log('⏸️ Not a horizontal swipe yet');
        }
    }

    function handleTouchEnd(e) {
        console.log('🏁 TOUCH END EVENT FIRED!');

        // 2024 Best Practice: Only prevent default if we handled a horizontal swipe
        if (isHorizontalSwipe) {
            e.preventDefault();
            e.stopPropagation();
        }

        if (!isDragging) {
            console.log('❌ Not dragging, returning');
            return;
        }

        isDragging = false;
        carouselTrack.style.transition = 'transform 300ms cubic-bezier(0.4, 0, 0.2, 1)';

        // Only process horizontal swipes
        if (isHorizontalSwipe) {
            const deltaX = currentX - startX;
            const deltaTime = Date.now() - startTime;
            const velocity = Math.abs(deltaX) / deltaTime;

            // DEBUG: Log all touch end values
            console.log('🔍 Touch End Debug:', {
                deltaX: deltaX,
                currentSlide: currentSlide,
                totalSlides: totalSlides,
                velocity: velocity,
                deltaTime: deltaTime,
                startX: startX,
                currentX: currentX,
                isHorizontalSwipe: isHorizontalSwipe,
                'deltaX > 0 (right swipe)': deltaX > 0,
                'deltaX < 0 (left swipe)': deltaX < 0,
                'Math.abs(deltaX)': Math.abs(deltaX)
            });

            // Determine swipe threshold based on distance and velocity
            const threshold = velocity > 0.5 ? 30 : 80; // Lower threshold for fast swipes
            console.log('📏 Threshold:', threshold, 'Distance:', Math.abs(deltaX));

            if (Math.abs(deltaX) > threshold) {
                console.log('✅ Swipe distance sufficient');

                // More explicit condition checking
                const swipingRight = deltaX > 0;
                const swipingLeft = deltaX < 0;
                const canGoBack = currentSlide > 0;
                const canGoForward = currentSlide < totalSlides - 1;

                console.log('Direction Analysis:', {
                    swipingRight: swipingRight,
                    swipingLeft: swipingLeft,
                    canGoBack: canGoBack,
                    canGoForward: canGoForward,
                    currentSlide: currentSlide,
                    totalSlides: totalSlides
                });

                if (swipingRight && canGoBack) {
                    console.log('👈 Swiping right (previous slide) - calling prevSlide()');
                    prevSlide();
                } else if (swipingLeft && canGoForward) {
                    console.log('👉 Swiping left (next slide) - calling nextSlide()');
                    nextSlide();
                } else {
                    console.log('🚫 At boundary or invalid condition - snapping back');
                    if (swipingRight && !canGoBack) {
                        console.log('Cannot go back - already at first slide');
                    } else if (swipingLeft && !canGoForward) {
                        console.log('Cannot go forward - already at last slide');
                    } else {
                        console.log('Unknown condition');
                    }
                    updateCarousel(currentSlide);
                }
            } else {
                console.log('❌ Swipe distance insufficient - snapping back');
                updateCarousel(currentSlide);
            }
        } else {
            console.log('🚫 Not a horizontal swipe - snapping back');
            updateCarousel(currentSlide);
        }

        // Reset all touch state
        startX = 0;
        startY = 0;
        currentX = 0;
        currentY = 0;
        isHorizontalSwipe = false;
        startTime = 0;
    }

    // Event listeners
    if (carouselPrev) {
        carouselPrev.addEventListener('click', prevSlide);
    }

    if (carouselNext) {
        carouselNext.addEventListener('click', nextSlide);
    }

    // Dot navigation is now handled during dot generation

    // iOS Safari Fix: Enhanced touch event setup with better compatibility
    console.log('🔧 Setting up iOS Safari compatible touch events...');
    console.log('carouselTrack element:', carouselTrack);
    console.log('🍎 iOS Safari detected:', /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream);

    if (carouselTrack) {
        console.log('✅ Attaching touch event listeners for carousel swipe functionality');

        // iOS Safari Fix: Enhanced event delegation with better target detection
        document.addEventListener('touchstart', function(e) {
            // Check if touch is within carousel area
            if (carouselTrack.contains(e.target) || e.target.closest('.carousel-container')) {
                handleTouchStart(e);
            }
        }, { passive: false });
        console.log('✅ document touchstart listener added with enhanced targeting');

        document.addEventListener('touchmove', function(e) {
            // Continue handling if we're dragging or if touch is in carousel area
            if (isDragging || (carouselTrack.contains(e.target) || e.target.closest('.carousel-container'))) {
                handleTouchMove(e);
            }
        }, { passive: false });
        console.log('✅ document touchmove listener added with enhanced targeting');

        document.addEventListener('touchend', function(e) {
            if (isDragging) {
                handleTouchEnd(e);
            }
        }, { passive: false });
        console.log('✅ document touchend listener added');

        // Handle touch cancellation with better cleanup
        document.addEventListener('touchcancel', function(e) {
            if (isDragging) {
                console.log('🚫 Touch cancelled - cleaning up');
                isDragging = false;
                isHorizontalSwipe = false;
                carouselTrack.style.transition = 'transform 300ms cubic-bezier(0.4, 0, 0.2, 1)';
                carouselTrack.style.touchAction = '';
                updateCarousel(currentSlide);
            }
        }, { passive: false });

        // iOS Safari Fix: Prevent context menu and selection on carousel
        carouselTrack.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        }, { passive: false });

        // iOS Safari Fix: Prevent text selection during swipe
        carouselTrack.addEventListener('selectstart', (e) => {
            if (isDragging) {
                e.preventDefault();
            }
        }, { passive: false });

        // iOS Safari Fix: Add CSS touch-action to carousel container
        carouselTrack.style.touchAction = 'pan-y pinch-zoom';

        console.log('🎯 All iOS Safari touch event listeners attached successfully with enhanced compatibility');

        // Test touch event detection
        console.log('🧪 Testing touch event detection...');
        const testTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        console.log('📱 Touch support detected:', testTouch);

        // Touch events are handled by document-level event delegation above

        // Add simple click handlers as fallback for testing
        carouselTrack.addEventListener('click', (e) => {
            console.log('🖱️ Click detected on carousel track');
            const rect = carouselTrack.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const trackWidth = rect.width;

            if (clickX < trackWidth / 2) {
                console.log('👈 Left side clicked - going to previous slide');
                prevSlide();
            } else {
                console.log('👉 Right side clicked - going to next slide');
                nextSlide();
            }
        });

    } else {
        console.error('❌ carouselTrack element not found!');
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') {
            prevSlide();
        } else if (e.key === 'ArrowRight') {
            nextSlide();
        }
    });

    // Initialize carousel
    updateCarousel(0, false);

    // DEBUG: Add manual test buttons (temporary)
    console.log('🧪 Debug functions available:');
    console.log('- window.testNextSlide() - manually trigger next slide');
    console.log('- window.testPrevSlide() - manually trigger previous slide');
    console.log('- window.testGoToSlide(index) - go to specific slide');

    window.testNextSlide = () => {
        console.log('🧪 Manual nextSlide test');
        nextSlide();
    };

    window.testPrevSlide = () => {
        console.log('🧪 Manual prevSlide test');
        prevSlide();
    };

    window.testGoToSlide = (index) => {
        console.log('🧪 Manual goToSlide test:', index);
        updateCarousel(index);
    };

    // 🚀 CARD CREATION HELPER FUNCTIONS
    function createHomeSettingsCard(homeSettings, formattedDate) {
        const card = document.createElement('div');
        card.className = 'figma-event-card carousel-slide';
        card.setAttribute('data-slide', '0');

        card.innerHTML = `
            <!-- Event Image with Gradient Background -->
            <div class="figma-event-image">
                ${homeSettings.event_image ?
                    `<img src="${homeSettings.event_image}" alt="${homeSettings.event_title}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 20px;" />` :
                    `<div class="figma-image-placeholder">
                        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>`
                }
            </div>

            <!-- Event Information -->
            <div class="figma-event-info">
                <h1 class="figma-event-title">${homeSettings.event_title}</h1>
                <h2 class="figma-event-artist">${homeSettings.artist_name}</h2>
                <p class="figma-event-date">${formattedDate}</p>
                <p class="figma-event-address">${homeSettings.event_address}</p>
            </div>

            <!-- Action Buttons -->
            <div class="figma-action-buttons">
                <button class="figma-btn figma-btn-primary" id="tickets-btn">
                    <span>Get Tickets</span>
                </button>
                <button class="figma-btn figma-btn-secondary" id="share-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Share</span>
                </button>
            </div>
        `;

        return card;
    }

    function createDropCard(drop, slideIndex) {
        const card = document.createElement('div');
        card.className = 'figma-event-card carousel-slide';
        card.setAttribute('data-slide', slideIndex.toString());

        // Format drop date
        let dropFormattedDate = "Event Date TBD";
        if (drop.event_date) {
            const eventDate = new Date(drop.event_date);
            const options = {
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            };
            dropFormattedDate = eventDate.toLocaleDateString('en-US', options)
                .replace(',', 'th,');
        }

        card.innerHTML = `
            <!-- Event Image with Gradient Background -->
            <div class="figma-event-image">
                ${drop.cover_image ?
                    `<img src="${drop.cover_image}" alt="${drop.title}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 20px;" />` :
                    `<div class="figma-image-placeholder" style="${drop.background_color ? `background: ${drop.background_color};` : ''}${drop.gradient_data ? `background: ${drop.gradient_data};` : ''}">
                        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>`
                }
            </div>

            <!-- Event Information -->
            <div class="figma-event-info">
                <h1 class="figma-event-title">${drop.title}</h1>
                <h2 class="figma-event-artist">${drop.artist_name || 'Artist Name'}</h2>
                <p class="figma-event-date">${dropFormattedDate}</p>
                <p class="figma-event-address">${drop.event_address || 'Event Address'}</p>
                ${drop.description ? `<p class="figma-event-description">${drop.description}</p>` : ''}
            </div>

            <!-- Action Buttons -->
            <div class="figma-action-buttons">
                <button class="figma-btn figma-btn-primary" onclick="window.open('/drop/${drop.slug}', '_blank')">
                    <span>${drop.button_text || 'Get Notified'}</span>
                </button>
                <button class="figma-btn figma-btn-secondary drop-share-btn" data-drop-title="${drop.title}" data-drop-slug="${drop.slug}">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Share</span>
                </button>
            </div>
        `;

        return card;
    }

    // 🚀 EXPOSE REFRESH FUNCTION GLOBALLY FOR REAL-TIME UPDATES
    window.refreshHomepageCards = refreshHomepageCards;

    // 🚀 REAL-TIME HOMEPAGE UPDATES VIA BROADCASTCHANNEL
    if (typeof BroadcastChannel !== 'undefined') {
        try {
            const channel = new BroadcastChannel('homepage-updates');

            channel.addEventListener('message', (event) => {
                console.log('📡 Received homepage update message:', event.data);

                if (event.data.type === 'refresh-cards') {
                    console.log('🔄 Refreshing homepage cards due to drop update...');
                    refreshHomepageCards();
                }
            });

            console.log('✅ BroadcastChannel listener setup for real-time homepage updates');
        } catch (error) {
            console.warn('⚠️ Failed to setup BroadcastChannel:', error.message);
        }
    } else {
        console.log('ℹ️ BroadcastChannel not supported - real-time updates disabled');
    }

    // Modal functionality for tickets (home settings)
    if (ticketsBtn) {
        ticketsBtn.addEventListener('click', function() {
            modalOverlay.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        });
    }

    if (modalClose) {
        modalClose.addEventListener('click', function() {
            modalOverlay.style.display = 'none';
            document.body.style.overflow = '';
        });
    }

    // Close modal when clicking outside
    if (modalOverlay) {
        modalOverlay.addEventListener('click', function(e) {
            if (e.target === modalOverlay) {
                modalOverlay.style.display = 'none';
                document.body.style.overflow = '';
            }
        });
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modalOverlay && modalOverlay.style.display === 'flex') {
            modalOverlay.style.display = 'none';
            document.body.style.overflow = '';
        }
    });

    // Share functionality with Web Share API and fallbacks
    async function handleShare(button, shareData) {
        try {
            // Try Web Share API first (mobile browsers)
            if (navigator.share) {
                await navigator.share(shareData);
                return;
            }

            // Fallback: Copy to clipboard
            await navigator.clipboard.writeText(`${shareData.title}\n${shareData.text}\n${shareData.url}`);

            // Show success feedback
            const originalText = button.innerHTML;
            button.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            button.style.backgroundColor = '#10b981';

            setTimeout(() => {
                button.innerHTML = originalText;
                button.style.backgroundColor = '';
            }, 2000);

        } catch (err) {
            console.error('Error sharing:', err);
            // Final fallback: Show share options
            alert('Share this event:\n\n' + shareData.title + '\n' + shareData.text + '\n' + shareData.url);
        }
    }

    shareBtn.addEventListener('click', async function() {
        const shareData = {
            title: '{{homeSettings.event_title}} - {{homeSettings.artist_name}}',
            text: 'Join us for an amazing event! {{formattedDate}} at {{homeSettings.event_address}}',
            url: window.location.href
        };
        await handleShare(this, shareData);
    });

    // Share functionality is now handled by the dynamic event listener above

    // Country flags and phone patterns from live drop
    const countryFlags = {
        '+1': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjEiIGhlaWdodD0iMTUiIHZpZXdCb3g9IjAgMCAyMSAxNSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjIxIiBoZWlnaHQ9IjE1IiBmaWxsPSIjQjIyMjM0Ii8+CjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNMCAwSDIxVjFIMFYwWk0wIDJIMjFWM0gwVjJaTTAgNEgyMVY1SDBWNFpNMCA2SDIxVjdIMFY2Wk0wIDhIMjFWOUgwVjhaTTAgMTBIMjFWMTFIMFYxMFpNMCAxMkgyMVYxM0gwVjEyWiIgZmlsbD0id2hpdGUiLz4KPHJlY3Qgd2lkdGg9IjkiIGhlaWdodD0iOCIgZmlsbD0iIzNDM0I2RSIvPgo8L3N2Zz4K',
        '+44': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjEiIGhlaWdodD0iMTUiIHZpZXdCb3g9IjAgMCAyMSAxNSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjIxIiBoZWlnaHQ9IjE1IiBmaWxsPSIjMDEyMTY5Ii8+CjxwYXRoIGQ9Ik0wIDBoMjF2MTVIMHoiIGZpbGw9IiMwMTIxNjkiLz4KPHBhdGggZD0iTTAgMGgyMXYxNUgweiIgZmlsbD0iIzAxMjE2OSIvPgo8L3N2Zz4K',
        '+49': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjEiIGhlaWdodD0iMTUiIHZpZXdCb3g9IjAgMCAyMSAxNSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjIxIiBoZWlnaHQ9IjE1IiBmaWxsPSIjMDAwMDAwIi8+CjxyZWN0IHk9IjUiIHdpZHRoPSIyMSIgaGVpZ2h0PSI1IiBmaWxsPSIjREQwMDAwIi8+CjxyZWN0IHk9IjEwIiB3aWR0aD0iMjEiIGhlaWdodD0iNSIgZmlsbD0iI0ZGQ0UwMCIvPgo8L3N2Zz4K',
        '+33': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjEiIGhlaWdodD0iMTUiIHZpZXdCb3g9IjAgMCAyMSAxNSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjciIGhlaWdodD0iMTUiIGZpbGw9IiMwMDIzOTUiLz4KPHJlY3QgeD0iNyIgd2lkdGg9IjciIGhlaWdodD0iMTUiIGZpbGw9IiNGRkZGRkYiLz4KPHJlY3QgeD0iMTQiIHdpZHRoPSI3IiBoZWlnaHQ9IjE1IiBmaWxsPSIjRUQyOTM5Ii8+Cjwvc3ZnPgo='
    };

    const phonePatterns = {
        '+1': { // US/Canada
            pattern: /^\d{10}$/,
            format: (num) => {
                if (num.length <= 3) return `(${num}`;
                if (num.length <= 6) return `(${num.slice(0,3)}) ${num.slice(3)}`;
                return `(${num.slice(0,3)}) ${num.slice(3,6)}-${num.slice(6,10)}`;
            },
            placeholder: '(555) 123-4567',
            maxLength: 14
        },
        '+44': { // UK
            pattern: /^\d{10,11}$/,
            format: (num) => {
                if (num.length <= 2) return num;
                if (num.length <= 6) return `${num.slice(0,2)} ${num.slice(2)}`;
                if (num.length === 10) return `${num.slice(0,2)} ${num.slice(2,6)} ${num.slice(6)}`;
                return `${num.slice(0,3)} ${num.slice(3,7)} ${num.slice(7)}`;
            },
            placeholder: '20 1234 5678',
            maxLength: 13
        },
        '+49': { // Germany
            pattern: /^\d{10,12}$/,
            format: (num) => {
                if (num.length <= 2) return num;
                if (num.length <= 5) return `${num.slice(0,2)} ${num.slice(2)}`;
                return `${num.slice(0,2)} ${num.slice(2,5)} ${num.slice(5)}`;
            },
            placeholder: '30 123 45678',
            maxLength: 15
        },
        '+33': { // France
            pattern: /^\d{10}$/,
            format: (num) => {
                if (num.length <= 2) return num;
                if (num.length <= 4) return `${num.slice(0,2)} ${num.slice(2)}`;
                if (num.length <= 6) return `${num.slice(0,2)} ${num.slice(2,4)} ${num.slice(4)}`;
                if (num.length <= 8) return `${num.slice(0,2)} ${num.slice(2,4)} ${num.slice(4,6)} ${num.slice(6)}`;
                return `${num.slice(0,2)} ${num.slice(2,4)} ${num.slice(4,6)} ${num.slice(6,8)} ${num.slice(8)}`;
            },
            placeholder: '01 23 45 67 89',
            maxLength: 14
        },
        '+34': { // Spain
            pattern: /^\d{9}$/,
            format: (num) => {
                if (num.length <= 3) return num;
                if (num.length <= 6) return `${num.slice(0,3)} ${num.slice(3)}`;
                return `${num.slice(0,3)} ${num.slice(3,6)} ${num.slice(6)}`;
            },
            placeholder: '612 345 678',
            maxLength: 11
        },
        '+39': { // Italy
            pattern: /^\d{9,11}$/,
            format: (num) => {
                if (num.length <= 3) return num;
                if (num.length <= 6) return `${num.slice(0,3)} ${num.slice(3)}`;
                return `${num.slice(0,3)} ${num.slice(3,6)} ${num.slice(6)}`;
            },
            placeholder: '312 345 6789',
            maxLength: 13
        },
        '+61': { // Australia
            pattern: /^\d{9}$/,
            format: (num) => {
                if (num.length <= 1) return num;
                if (num.length <= 5) return `${num.slice(0,1)} ${num.slice(1)}`;
                return `${num.slice(0,1)} ${num.slice(1,5)} ${num.slice(5)}`;
            },
            placeholder: '4 1234 5678',
            maxLength: 12
        },
        '+81': { // Japan
            pattern: /^\d{10,11}$/,
            format: (num) => {
                if (num.length <= 2) return num;
                if (num.length <= 6) return `${num.slice(0,2)}-${num.slice(2)}`;
                if (num.length === 10) return `${num.slice(0,2)}-${num.slice(2,6)}-${num.slice(6)}`;
                return `${num.slice(0,3)}-${num.slice(3,7)}-${num.slice(7)}`;
            },
            placeholder: '90-1234-5678',
            maxLength: 13
        },
        '+82': { // South Korea
            pattern: /^\d{9,11}$/,
            format: (num) => {
                if (num.length <= 2) return num;
                if (num.length <= 6) return `${num.slice(0,2)}-${num.slice(2)}`;
                return `${num.slice(0,2)}-${num.slice(2,6)}-${num.slice(6)}`;
            },
            placeholder: '10-1234-5678',
            maxLength: 13
        },
        '+91': { // India
            pattern: /^\d{10}$/,
            format: (num) => {
                if (num.length <= 5) return num;
                return `${num.slice(0,5)} ${num.slice(5)}`;
            },
            placeholder: '98765 43210',
            maxLength: 11
        },
        '+86': { // China
            pattern: /^\d{11}$/,
            format: (num) => {
                if (num.length <= 3) return num;
                if (num.length <= 7) return `${num.slice(0,3)} ${num.slice(3)}`;
                return `${num.slice(0,3)} ${num.slice(3,7)} ${num.slice(7)}`;
            },
            placeholder: '138 0013 8000',
            maxLength: 13
        },
        '+55': { // Brazil
            pattern: /^\d{10,11}$/,
            format: (num) => {
                if (num.length <= 2) return `(${num}`;
                if (num.length <= 6) return `(${num.slice(0,2)}) ${num.slice(2)}`;
                if (num.length === 10) return `(${num.slice(0,2)}) ${num.slice(2,6)}-${num.slice(6)}`;
                return `(${num.slice(0,2)}) ${num.slice(2,7)}-${num.slice(7)}`;
            },
            placeholder: '(11) 91234-5678',
            maxLength: 15
        },
        '+52': { // Mexico
            pattern: /^\d{10}$/,
            format: (num) => {
                if (num.length <= 3) return num;
                if (num.length <= 6) return `${num.slice(0,3)} ${num.slice(3)}`;
                return `${num.slice(0,3)} ${num.slice(3,6)} ${num.slice(6)}`;
            },
            placeholder: '555 123 4567',
            maxLength: 12
        }
    };

    let currentCountryCode = '+1';
    let validationTimeout;

    // Robust phone number formatting function with progressive formatting
    function formatPhoneNumber(value, countryCode = currentCountryCode) {
        const phoneNumber = value.replace(/[^\d]/g, '');
        if (phoneNumber.length === 0) return '';

        const pattern = phonePatterns[countryCode];
        if (!pattern) return phoneNumber;

        try {
            return pattern.format(phoneNumber);
        } catch (error) {
            return phoneNumber;
        }
    }

    // Calculate cursor position after formatting
    function calculateCursorPosition(oldValue, newValue, oldCursor, isDeleting = false) {
        // If deleting, try to maintain relative position
        if (isDeleting) {
            // Find the position in the clean number
            const cleanOld = oldValue.replace(/[^\d]/g, '');
            const cleanNew = newValue.replace(/[^\d]/g, '');

            // Count digits before cursor in old value
            let digitsBefore = 0;
            for (let i = 0; i < Math.min(oldCursor, oldValue.length); i++) {
                if (/\d/.test(oldValue[i])) digitsBefore++;
            }

            // Find position after same number of digits in new value
            let newPos = 0;
            let digitsFound = 0;
            for (let i = 0; i < newValue.length && digitsFound < digitsBefore; i++) {
                if (/\d/.test(newValue[i])) digitsFound++;
                newPos = i + 1;
            }

            return Math.min(newPos, newValue.length);
        }

        // For adding characters, place cursor after the last typed digit
        const cleanOld = oldValue.replace(/[^\d]/g, '');
        const cleanNew = newValue.replace(/[^\d]/g, '');

        if (cleanNew.length > cleanOld.length) {
            // Find position after the newly added digit
            let digitCount = 0;
            for (let i = 0; i < newValue.length; i++) {
                if (/\d/.test(newValue[i])) {
                    digitCount++;
                    if (digitCount === cleanNew.length) {
                        return i + 1;
                    }
                }
            }
        }

        // Default: try to maintain relative position
        const ratio = oldCursor / Math.max(oldValue.length, 1);
        return Math.round(ratio * newValue.length);
    }

    // International phone number validation
    function isValidPhoneNumber(value, countryCode = currentCountryCode) {
        const phoneNumber = value.replace(/[^\d]/g, '');
        const pattern = phonePatterns[countryCode];
        if (!pattern) {
            return phoneNumber.length >= 10 && phoneNumber.length <= 15;
        }
        return pattern.pattern.test(phoneNumber);
    }

    // Enhanced validation state management
    function updateValidationState(state, message = '', type = 'neutral') {
        const container = phoneInput.closest('.phone-input-container');
        const messageElement = document.getElementById('phone-validation-message');
        const phoneInputElement = document.getElementById('phoneInput');

        // Clear existing states
        container.classList.remove('valid', 'invalid', 'loading', 'shake');
        messageElement.classList.remove('show', 'error', 'success', 'help');

        // Set ARIA attributes
        phoneInputElement.setAttribute('aria-invalid', state === 'invalid' ? 'true' : 'false');

        // Apply new state
        if (state !== 'neutral') {
            container.classList.add(state);
        }

        // Show message if provided
        if (message) {
            messageElement.textContent = message;
            messageElement.classList.add('show', type);

            // Auto-hide help messages after 5 seconds
            if (type === 'help') {
                setTimeout(() => {
                    hideValidationMessage();
                }, 5000);
            }
        } else {
            hideValidationMessage();
        }

        // Add shake animation for errors
        if (state === 'invalid' && type === 'error') {
            container.classList.add('shake');
            setTimeout(() => {
                container.classList.remove('shake');
            }, 400);
        }
    }

    function hideValidationMessage() {
        const messageElement = document.getElementById('phone-validation-message');
        messageElement.classList.remove('show', 'error', 'success', 'help');
    }

    function showValidationMessage(message, type = 'help') {
        const messageElement = document.getElementById('phone-validation-message');
        messageElement.textContent = message;
        messageElement.classList.remove('error', 'success', 'help');
        messageElement.classList.add('show', type);
    }

    // Debounced validation function
    function validatePhoneWithDelay(value, countryCode) {
        clearTimeout(validationTimeout);

        // Handle completely empty input
        if (value.length === 0) {
            updateValidationState('neutral');
            return;
        }

        // Get clean digits only
        const cleanDigits = value.replace(/[^\d]/g, '');

        // If no digits, treat as empty
        if (cleanDigits.length === 0) {
            updateValidationState('neutral');
            return;
        }

        // Show loading state for non-empty input
        updateValidationState('loading');

        validationTimeout = setTimeout(() => {
            const isValid = isValidPhoneNumber(value, countryCode);
            const pattern = phonePatterns[countryCode];
            const countryOption = document.querySelector(`option[value="${countryCode}"]`);
            const countryName = countryOption?.dataset.name || countryCode;

            if (isValid) {
                updateValidationState('valid', `✓ Valid ${countryName} phone number`, 'success');
            } else if (cleanDigits.length > 0) {
                const exampleFormat = pattern ? pattern.placeholder : 'valid format';
                updateValidationState('invalid',
                    `Please enter a valid ${countryName} phone number (e.g., ${exampleFormat})`,
                    'error'
                );
            } else {
                updateValidationState('neutral');
            }
        }, 300); // 300ms debounce delay
    }

    // Country selection functionality
    countrySelect.addEventListener('change', function() {
        const selectedCode = this.value;
        const selectedOption = this.options[this.selectedIndex];

        // Update flag display
        const flagImg = countryFlagDisplay.querySelector('img');
        if (flagImg && countryFlags[selectedCode]) {
            flagImg.src = countryFlags[selectedCode];
            flagImg.alt = selectedOption.dataset.name || 'Country flag';
        }

        // Update current country code
        currentCountryCode = selectedCode;

        // Update phone input placeholder and maxlength based on country
        if (phoneInput && phonePatterns[selectedCode]) {
            const pattern = phonePatterns[selectedCode];
            phoneInput.placeholder = pattern.placeholder;
            phoneInput.maxLength = pattern.maxLength;

            // Clear and reformat existing phone number for new country
            if (phoneInput.value) {
                const cleanNumber = phoneInput.value.replace(/[^\d]/g, '');
                phoneInput.value = formatPhoneNumber(cleanNumber, selectedCode);
            }
        }

        // Focus phone input after country selection for better UX
        if (phoneInput) {
            phoneInput.focus();

            // Re-validate with new country if there's existing input
            const currentValue = phoneInput.value.trim();
            if (currentValue.length > 0) {
                // Clear validation state first
                updateValidationState('neutral');

                // Re-format and validate with new country
                const cleanNumber = currentValue.replace(/[^\d]/g, '');
                if (cleanNumber.length > 0) {
                    const newFormattedValue = formatPhoneNumber(cleanNumber, selectedCode);
                    phoneInput.value = newFormattedValue;
                    validatePhoneWithDelay(newFormattedValue, selectedCode);
                }
            }
        }
    });

    // Enhanced input handler with robust formatting and cursor management
    let isComposing = false;
    let lastInputType = '';

    phoneInput.addEventListener('compositionstart', () => { isComposing = true; });
    phoneInput.addEventListener('compositionend', () => { isComposing = false; });

    phoneInput.addEventListener('beforeinput', function(e) {
        lastInputType = e.inputType || '';
    });

    phoneInput.addEventListener('input', function(e) {
        // Skip processing during composition (for international keyboards)
        if (isComposing) return;

        const cursorPosition = e.target.selectionStart;
        const oldValue = phoneInput.dataset.lastValue || '';
        const inputValue = e.target.value;

        // Store current value for next comparison
        phoneInput.dataset.lastValue = inputValue;

        // Handle complete clearing
        if (inputValue === '') {
            e.target.value = '';
            updateValidationState('neutral');
            return;
        }

        // Detect if this was a deletion operation
        const isDeleting = lastInputType.includes('delete') ||
                          inputValue.length < oldValue.length ||
                          inputValue.replace(/[^\d]/g, '').length < oldValue.replace(/[^\d]/g, '').length;

        // Format the phone number
        const newValue = formatPhoneNumber(inputValue, currentCountryCode);

        // Only update if the formatted value is different
        if (newValue !== inputValue) {
            e.target.value = newValue;

            // Calculate and set new cursor position
            const newCursorPosition = calculateCursorPosition(oldValue, newValue, cursorPosition, isDeleting);

            // Use requestAnimationFrame to ensure DOM is updated before setting cursor
            requestAnimationFrame(() => {
                e.target.setSelectionRange(newCursorPosition, newCursorPosition);
            });
        }

        // Update stored value after formatting
        phoneInput.dataset.lastValue = newValue;

        // Validate with debouncing
        validatePhoneWithDelay(newValue, currentCountryCode);
    });

    // Show help message on focus
    phoneInput.addEventListener('focus', function(e) {
        const pattern = phonePatterns[currentCountryCode];
        const countryOption = document.querySelector(`option[value="${currentCountryCode}"]`);
        const countryName = countryOption?.dataset.name || currentCountryCode;
        const exampleFormat = pattern ? pattern.placeholder : 'valid format';

        if (e.target.value.length === 0) {
            showValidationMessage(`Enter your ${countryName} phone number (e.g., ${exampleFormat})`, 'help');
        }
    });

    // Enhanced keydown handler for better UX
    phoneInput.addEventListener('keydown', function(e) {
        // Allow navigation and selection keys
        const allowedKeys = [
            'Backspace', 'Delete', 'Tab', 'Escape', 'Enter', 'Home', 'End',
            'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'
        ];

        // Allow Ctrl/Cmd combinations
        if (e.ctrlKey || e.metaKey) {
            const allowedCtrlKeys = ['a', 'c', 'v', 'x', 'z', 'y'];
            if (allowedCtrlKeys.includes(e.key.toLowerCase())) {
                return; // Allow these combinations
            }
        }

        // Allow allowed keys
        if (allowedKeys.includes(e.key)) {
            return;
        }

        // Allow numeric keys (both main keyboard and numpad)
        if ((e.key >= '0' && e.key <= '9') ||
            (e.keyCode >= 96 && e.keyCode <= 105)) {
            return;
        }

        // Block everything else
        e.preventDefault();
    });

    // Handle paste events for better UX
    phoneInput.addEventListener('paste', function(e) {
        e.preventDefault();

        // Get pasted content
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');

        // Extract only digits from pasted content
        const digits = pastedText.replace(/[^\d]/g, '');

        if (digits.length > 0) {
            // Format the pasted digits
            const formattedValue = formatPhoneNumber(digits, currentCountryCode);

            // Set the formatted value
            e.target.value = formattedValue;
            phoneInput.dataset.lastValue = formattedValue;

            // Place cursor at the end
            const cursorPos = formattedValue.length;
            requestAnimationFrame(() => {
                e.target.setSelectionRange(cursorPos, cursorPos);
            });

            // Validate the pasted content
            validatePhoneWithDelay(formattedValue, currentCountryCode);
        }
    });

    // Validate on blur
    phoneInput.addEventListener('blur', function(e) {
        const value = e.target.value.trim();
        if (value.length > 0) {
            const cleanDigits = value.replace(/[^\d]/g, '');
            if (cleanDigits.length > 0) {
                const isValid = isValidPhoneNumber(value, currentCountryCode);
                const pattern = phonePatterns[currentCountryCode];
                const countryOption = document.querySelector(`option[value="${currentCountryCode}"]`);
                const countryName = countryOption?.dataset.name || currentCountryCode;

                if (isValid) {
                    updateValidationState('valid', `✓ Valid ${countryName} phone number`, 'success');
                } else {
                    const exampleFormat = pattern ? pattern.placeholder : 'valid format';
                    updateValidationState('invalid',
                        `Please enter a valid ${countryName} phone number (e.g., ${exampleFormat})`,
                        'error'
                    );
                }
            } else {
                updateValidationState('neutral');
            }
        } else {
            updateValidationState('neutral');
        }
    });

    // Send button functionality with enhanced validation
    sendBtn.addEventListener('click', function(e) {
        e.preventDefault();

        const phoneValue = phoneInput.value.trim();
        const countryCode = currentCountryCode;

        if (!phoneValue) {
            updateValidationState('invalid', 'Please enter a phone number', 'error');
            phoneInput.focus();
            return;
        }

        // Use international validation
        if (!isValidPhoneNumber(phoneValue, countryCode)) {
            const pattern = phonePatterns[countryCode];
            const countryOption = document.querySelector(`option[value="${countryCode}"]`);
            const countryName = countryOption && countryOption.dataset.name ? countryOption.dataset.name : countryCode;
            const exampleFormat = pattern ? pattern.placeholder : 'valid format';

            updateValidationState('invalid',
                `Please enter a valid ${countryName} phone number (e.g., ${exampleFormat})`,
                'error'
            );
            phoneInput.focus();
            return;
        }

        // Show loading state
        updateValidationState('loading', 'Sending...', 'help');

        // Show success state
        const originalText = this.textContent;
        this.textContent = 'SENT!';
        this.style.backgroundColor = '#10b981';
        this.disabled = true;

        // Simulate success
        setTimeout(() => {
            updateValidationState('valid', '✓ Message sent successfully!', 'success');

            // Reset after 3 seconds
            setTimeout(() => {
                this.textContent = originalText;
                this.style.backgroundColor = '';
                this.disabled = false;
                phoneInput.value = '';
                updateValidationState('neutral');
            }, 3000);
        }, 1000);

        console.log('Phone submission:', { phone: phoneValue, country: countryCode });
    });

    // Ensure mobile font size is 16px to prevent zoom
    if (window.innerWidth <= 767) {
        phoneInput.style.fontSize = '16px';
    }
});
</script>
